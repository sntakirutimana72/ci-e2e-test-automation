name: XYZ Bank CI
run-name: Cross-Browser Testing with Allure

on:
  push:
    branches: [ xyz-bank-app ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
      fail-fast: false

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Cache Maven dependencies
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # Browser-specific setup (since you mentioned auto-setup dependency, these are lightweight)
      - name: Setup Chrome
        if: matrix.browser == 'chrome'
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Setup Firefox
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@v1

      - name: Setup Edge
        if: matrix.browser == 'edge'
        uses: browser-actions/setup-edge@v1

      # Run tests with browser-specific configuration
      - name: Run tests - ${{ matrix.browser }}
        run: |
          mvn clean test \
            -Dbrowser=${{ matrix.browser }} \
            -Djacoco.destFile=target/jacoco-${{ matrix.browser }}.exec
        continue-on-error: true

      # Upload coverage report for each browser
      - name: Upload JaCoCo report - ${{ matrix.browser }}
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-${{ matrix.browser }}
          path: target/jacoco-${{ matrix.browser }}.exec

      # Upload browser-specific results
      - name: Upload Allure results - ${{ matrix.browser }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-${{ matrix.browser }}
          path: target/allure-results/
          retention-days: 30

      # Upload screenshots on failure
      - name: Upload screenshots - ${{ matrix.browser }}
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-${{ matrix.browser }}
          path: screenshots/
          retention-days: 7

      # Set status icons for Slack notification
      - name: Set success icon
        if: success()
        run: 'echo "SLACK_STATUS_ICON=:white_check_mark: PASSED" >> $GITHUB_ENV'

      - name: Set failure icon
        if: failure()
        run: 'echo "SLACK_STATUS_ICON=:x: FAILED" >> $GITHUB_ENV'

      - name: Set cancellation icon
        if: cancelled()
        run: 'echo "SLACK_STATUS_ICON=:warning: CANCELLED" >> $GITHUB_ENV'

      # Send Slack notification on job completion
      - name: Slack Notification - Job Finished
        if: always()
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":rocket: *${{ matrix.browser }} Test Results:* ${{ env.SLACK_STATUS_ICON }}"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":computer: *Browser:* `${{ matrix.browser }}`\n:gear: *Workflow:* `${{ github.workflow }}`\n:bar_chart: *Status:* `${{ job.status }}`"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":herb: *Branch:* `${{ github.ref }}`\n:memo: *Commit:* `${{ github.sha }}`\n:bust_in_silhouette: *Author:* `${{ github.actor }}`"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":speech_balloon: *Commit message:* `${{ github.event.head_commit.message }}`"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":link: *<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>*"

  # Generate combined Allure report
  generate-allure-report:
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Download all browser results
      - name: Download Chrome results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: allure-results-chrome
          path: allure-results/chrome/

      - name: Download Firefox results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: allure-results-firefox
          path: allure-results/firefox/

      - name: Download Edge results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: allure-results-edge
          path: allure-results/edge/

      # Combine results from all browsers
      - name: Combine Allure results
        run: |
          mkdir -p combined-results
          # Copy results from each browser, handling cases where some may not exist
          for browser in chrome firefox edge; do
            if [ -d "allure-results/$browser" ]; then
              echo "Copying results from $browser..."
              cp -r allure-results/$browser/* combined-results/ 2>/dev/null || true
            else
              echo "No results found for $browser"
            fi
          done
          # List combined results for verification
          echo "Combined results:"
          ls -la combined-results/ || echo "No combined results found"

      # Get Allure history for trending
      - name: Get Allure history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      # Generate combined Allure report
      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: combined-results
          allure_history: allure-history
          keep_reports: 20

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
          force_orphan: true

      # Set report generation status
      - name: Set report success icon
        if: success()
        run: 'echo "REPORT_STATUS_ICON=:white_check_mark: REPORT GENERATED" >> $GITHUB_ENV'

      - name: Set report failure icon
        if: failure()
        run: 'echo "REPORT_STATUS_ICON=:x: REPORT FAILED" >> $GITHUB_ENV'

      - name: Set report cancellation icon
        if: cancelled()
        run: 'echo "REPORT_STATUS_ICON=:warning: REPORT CANCELLED" >> $GITHUB_ENV'

      # Send final Slack notification with report status
      - name: Slack Notification - Report Generation Finished
        if: always()
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":bar_chart: *Allure Report Status:* ${{ env.REPORT_STATUS_ICON }}"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":gear: *Workflow:* `${{ github.workflow }}`\n:herb: *Branch:* `${{ github.ref }}`\n:bust_in_silhouette: *Author:* `${{ github.actor }}`"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":globe_with_meridians: *<https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}|View Allure Report>*"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":link: *<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>*"

  generate-coverage-report:
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Download all jacoco exec files
      - name: Download Chrome exec
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: jacoco-chrome
          path: ./jacoco-files

      - name: Download Firefox exec
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: jacoco-firefox
          path: ./jacoco-files

      - name: Download Edge exec
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: jacoco-edge
          path: ./jacoco-files

      # Merge exec files
      - name: Merge JaCoCo exec files
        run: |
          mvn jacoco:merge \
            -Djacoco.fileSets[0].directory=target \
            -Djacoco.fileSets[0].includes=jacoco-*.exec \
            -Djacoco.destFile=target/jacoco-merged.exec

      # Generate a report from merged exec
      - name: Generate merged JaCoCo report
        run: |
          mvn jacoco:report \
          -Djacoco.dataFile=target/jacoco-merged.exec \
          -Djacoco.outputDirectory=target/site/jacoco

      # Upload merged XML to Coveralls
      - name: Upload coverage report to Coveralls
        uses: coverallsapp/github-action@v2
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: target/site/jacoco/jacoco.xml

      # Set report generation status
      - name: Set report success icon
        if: success()
        run: 'echo "COVERALLS_STATUS_ICON=:white_check_mark: REPORT GENERATED" >> $GITHUB_ENV'

      - name: Set report failure icon
        if: failure()
        run: 'echo "COVERALLS_STATUS_ICON=:x: REPORT FAILED" >> $GITHUB_ENV'

      - name: Set report cancellation icon
        if: cancelled()
        run: 'echo "COVERALLS_STATUS_ICON=:warning: REPORT CANCELLED" >> $GITHUB_ENV'

      # Send final Slack notification with coverage report status
      - name: Slack Notification - Report Generation Finished
        if: always()
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":bar_chart: *Coverage Report Status:* ${{ env.COVERALLS_STATUS_ICON }}"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":gear: *Workflow:* `${{ github.workflow }}`\n:herb: *Branch:* `${{ github.ref }}`\n:bust_in_silhouette: *Author:* `${{ github.actor }}`"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":globe_with_meridians: *<https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}|View Allure Report>*"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":link: *<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>*"  
